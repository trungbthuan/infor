{% extends "sidebar.html" %} {% load static %} {% block title %} Form edit {% endblock %} {% block content %}
<link rel="stylesheet" href="{% static 'css/myStyle.css' %}" />
<link rel="stylesheet" href="{% static 'css/btnStyle.css' %}" />
<link rel="stylesheet" href="{% static 'css/inputStyle.css' %}" />

<h1>Cập nhật thông tin</h1>
<p>I'm testing form edit</p>

<form>
   {% comment %} method="POST" action="{% url 'profiles_update' id=profile.id %}"> {% endcomment %} {% csrf_token %}

   <div class="flex-col">
      <div class="form" style="width: 250px; height: 40px">
         <input name="full_name" type="text" id="full_name" class="form__input" autocomplete="off" placeholder=" " value="{{ profile.full_name }}" />
         <label for="full_name" class="form__label">Họ tên</label>
      </div>
      <div class="form" style="width: 250px; height: 40px">
         <input name="birthday" type="date" id="birthday" class="form__input" required value="{{ profile.birthday|date:'Y-m-d' }}" placeholder=" " />
         <label for="birthday" class="form__label">Ngày sinh</label>
      </div>
      <div class="form" style="width: 250px; height: 40px">
         <input name="sex" type="text" id="sex" class="form__input" autocomplete="off" placeholder=" " value="{{ profile.sex }}" />
         <label for="sex" class="form__label">Giới tính</label>
      </div>
      <div class="form" style="width: 250px; height: 40px">
         <input name="birth_place" type="text" id="birth_place" class="form__input" autocomplete="off" placeholder=" " value="{{ profile.birth_place }}" />
         <label for="birth_place" class="form__label">Nơi sinh</label>
      </div>
      <div class="form" style="width: 250px; height: 40px">
         <input name="nation" type="text" id="nation" class="form__input" autocomplete="off" placeholder=" " value="{{ profile.nation }}" />
         <label for="nation" class="form__label">Dân tộc</label>
      </div>
      <div class="form" style="width: 250px; height: 40px">
         <input name="recruitment_day" type="date" id="recruitment_day" class="form__input" required value="{{ profile.recruitment_day|date:'Y-m-d' }}" placeholder=" " />
         <label for="recruitment_day" class="form__label">Ngày vào làm</label>
      </div>

      <div class="form" style="width: 250px; height: 40px">
         <input name="job_title" type="text" id="job_title" class="form__input" autocomplete="off" placeholder=" " value="{{ profile.job_title }}" />
         <label for="job_title" class="form__label">Công việc</label>
      </div>
      <div class="form" style="width: 250px; height: 40px">
         <input name="department" type="text" id="department" class="form__input" autocomplete="off" placeholder=" " value="{{ profile.department }}" />
         <label for="department" class="form__label">Phòng/ban</label>
      </div>
      <button type="button" name="btn_edit" style="width: 120px; height: 39px" class="btn-like" onclick="ajax_save()">Cập nhật</button>
   </div>
</form>
<script>
   function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
         const cookies = document.cookie.split(";");
         for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
               cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
               break;
            }
         }
      }
      return cookieValue;
   }

   // Khai báo biến cần thiết
   const csrftoken = getCookie("csrftoken");

   // Giá trị này được giữ nguyên trong suốt quá trình người dùng edit.
   const profileId = "{{ profile.id }}";

   function ajax_save() {
      const apiUrl = `http://127.0.0.1:8080/api/profile/${profileId}/`;

      // Thu thập dữ liệu
      const updatedData = {
         full_name: document.getElementById("full_name").value,
         birthday: document.getElementById("birthday").value,
         sex: document.getElementById("sex").value,
         birth_place: document.getElementById("birth_place").value,
         nation: document.getElementById("nation").value,
         recruitment_day: document.getElementById("recruitment_day").value,
         job_title: document.getElementById("job_title").value,
         department: document.getElementById("department").value,
      };

      fetch(apiUrl, {
         method: "PATCH",
         headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken,
         },
         body: JSON.stringify(updatedData),
      })
         .then((response) => {
            if (!response.ok) {
               return response.json().then((errorData) => {
                  // Ném lỗi với chi tiết từ server
                  throw new Error(JSON.stringify(errorData));
               });
            }
            return response.json();
         })
         // Nhận dữ liệu trả về và sử dụng nó
         .then((updatedProfile) => {
            // Dữ liệu JSON đã chuyển đổi được gán cho updatedProfile
            alert(`Cập nhật hồ sơ ${updatedProfile.full_name} thành công!`);
            // CHUYỂN HƯỚNG: Trở lại trang danh sách sau khi lưu thành công
            window.location.href = "{% url 'ajax_update' %}";
         })
         .catch((error) => {
            console.error("Lỗi khi cập nhật:", error);
            // Hiển thị lỗi thân thiện hơn
            alert("Cập nhật thất bại: " + error.message);
         });
   }
</script>

{% endblock %}
