{% extends "sidebar.html" %} {% load static %} {% block title %} This is students page {% endblock %} {% block content %}
<link rel="stylesheet" href="{% static 'css/myTable.css' %}" />
<link rel="stylesheet" href="{% static 'css/myStyle.css' %}" />
<link rel="stylesheet" href="{% static 'css/inputStyle.css' %}" />
<link rel="stylesheet" href="{% static 'css/btnStyle.css' %}" />

{% block extra_css %}{% endblock %}
<h1>Danh s√°ch th√¥ng tin nh√¢n vi√™n</h1>

<table id="table" class="styled-table">
    <thead>
        <tr>
            <th>Stt</th>
            <th>Id</th>
            <th>Full Name</th>
            <th>Birthday</th>
            <th>Sex</th>
            <th>Birth place</th>
            <th>Nation</th>
            <th>Recruitment day</th>
            <th>Job title</th>
            <th>Department</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="profile-table-body"></tbody>
</table>

<button onclick="fetchProfiles()" class="btn-like">T·∫£i Danh S√°ch H·ªì S∆°</button>
<p id="loading-status" style="color: blue">Nh·∫•n n√∫t ƒë·ªÉ t·∫£i d·ªØ li·ªáu...</p>

<script>
    //const API_URL = "http://127.0.0.1:8080/api/profile/";
    const API_URL = "/api/profile/";
    //const API_URL = "https://infor-0cgw.onrender.com/api/profile/";
    const tableBody = document.getElementById("profile-table-body");
    const statusElement = document.getElementById("loading-status");
    let table = document.getElementById("table");
    const csrftoken = getCookie("csrftoken");
    window.IS_USER_LOGGED_IN = {{ user.is_authenticated|yesno:"true,false" }};

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === name + "=") {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    function ajax_EditProfile(id, full_name) {
        const confirmEdit = confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën s·ª≠a h·ªì s∆° ${full_name} kh√¥ng?`);
        if (confirmEdit) {
            // S·ª≠ d·ª•ng ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi, Django s·∫Ω t·ª± hi·ªÉu domain hi·ªán t·∫°i
            const editUrl = `/ajax/ajax_call_view_edit/${id}/`;
            window.location.href = editUrl;
        }
    }

    function ajax_DeleteProfile(id, full_name) {
        // 1. Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p th·∫≠t s·ª± t·ª´ Django
        if (typeof window.IS_USER_LOGGED_IN === 'undefined' || window.IS_USER_LOGGED_IN !== true) {
            alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán ch·ª©c nƒÉng n√†y!");
            window.location.href = "/login/";
            return; // D·ª´ng h√†m t·∫°i ƒë√¢y
        }

        // N·∫øu ƒë√£ ƒëƒÉng nh·∫≠p m·ªõi ch·∫°y xu·ªëng ƒë√¢y
        const confirmDelete = confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h·ªì s∆° ${full_name} kh√¥ng?`);
        if (confirmDelete) {
            // URL API Endpoint ƒë·ªÉ x√≥a h·ªì s∆°
            const apiUrl = `/api/profile/${id}/`;

            fetch(apiUrl, {
                method: "DELETE", // üí• S·ª¨ D·ª§NG PH∆Ø∆†NG TH·ª®C HTTP DELETE
                headers: {
                    "X-CSRFToken": csrftoken, // üí• G·ª≠i CSRF Token ƒë·ªÉ b·∫£o m·∫≠t
                },
            })
                .then((response) => {
                    // Ki·ªÉm tra m√£ ph·∫£n h·ªìi
                    if (response.ok) {
                        // M√£ 204 No Content l√† ph·∫£n h·ªìi th√†nh c√¥ng cho DELETE

                        // üí• TH√ÄNH C√îNG: X√≥a h√†ng kh·ªèi b·∫£ng HTML m√† kh√¥ng c·∫ßn t·∫£i l·∫°i trang
                        const rowToRemove = document.getElementById(`profile-row-${id}`);
                        if (rowToRemove) {
                            rowToRemove.remove();
                        }
                        alert(`ƒê√£ x√≥a h·ªì s∆° ${full_name} th√†nh c√¥ng.`);
                    } else {
                        // X·ª≠ l√Ω l·ªói t·ª´ server (v√≠ d·ª•: kh√¥ng c√≥ quy·ªÅn, h·ªì s∆° kh√¥ng t·ªìn t·∫°i)
                        return response.json().then((errorData) => {
                            alert(`X√≥a th·∫•t b·∫°i. L·ªói: ${JSON.stringify(errorData)}`);
                        });
                    }
                })
                .catch((error) => {
                    // X·ª≠ l√Ω l·ªói m·∫°ng (Network error)
                    console.error("L·ªói m·∫°ng ho·∫∑c x·ª≠ l√Ω:", error);
                    alert("C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh x√≥a.");
                });
        }
    }

    function fetchProfiles() {
        statusElement.textContent = "ƒêang t·∫£i d·ªØ li·ªáu...";
        tableBody.innerHTML = ""; // X√≥a d·ªØ li·ªáu c≈© n·∫øu c√≥

        // 1. G·ª≠i y√™u c·∫ßu GET b·∫±ng Fetch API
        fetch(API_URL)
            // 2. X·ª≠ l√Ω ph·∫£n h·ªìi (response) ƒë·∫ßu ti√™n
            .then((response) => {
                // Ki·ªÉm tra xem ph·∫£n h·ªìi c√≥ th√†nh c√¥ng kh√¥ng (M√£ 200-299)
                if (!response.ok) {
                    throw new Error(`L·ªói HTTP! Tr·∫°ng th√°i: ${response.status}`);
                }
                // Chuy·ªÉn ƒë·ªïi n·ªôi dung ph·∫£n h·ªìi th√†nh JSON
                return response.json();
            })
            // 3. X·ª≠ l√Ω d·ªØ li·ªáu JSON ƒë√£ nh·∫≠n (data l√† danh s√°ch h·ªì s∆°)
            .then((data) => {
                if (data.length === 0) {
                    statusElement.textContent = "Kh√¥ng t√¨m th·∫•y h·ªì s∆° n√†o.";
                    return;
                }

                let stt = 0;

                data.forEach((profile) => {
                    stt++;
                    // T·∫°o m·ªôt h√†ng m·ªõi (<tr>)
                    const row = document.createElement("tr");

                    // Th√™m ID ƒë·ªÉ d·ªÖ d√†ng thao t√°c sau n√†y (v√≠ d·ª•: x√≥a)
                    row.id = `profile-row-${profile.id}`;

                    // T·∫°o n·ªôi dung HTML cho h√†ng
                    row.innerHTML = `
                        <td>${zeroPad(stt.toString(), 3, "0")}</td>
                        <td>${profile.id}</td>
                        <td>${profile.full_name}</td>
                        <td>${profile.birthday || "N/A"}</td>
                        <td>${profile.sex}</td>
                        <td>${profile.birth_place}</td>
                        <td>${profile.nation}</td>
                        <td>${profile.recruitment_day || "N/A"}</td>
                        <td>${profile.job_title}</td>
                        <td>${profile.department}</td>
                        <td>
                            <div class="flex-row">
                                <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
                                <button type="button" class="cir-button bg-edit" style="margin-left: 5px" onclick="ajax_EditProfile('${profile.id}', '${profile.full_name}')"></button>
                                <button id="btn_delete" type="button" class="cir-button bg-delete" style="margin-left: 5px" onclick="ajax_DeleteProfile('${profile.id}', '${profile.full_name}')"></button>
                            </div>
                        </td>
                    `;
                    // Th√™m h√†ng v√†o b·∫£ng
                    tableBody.appendChild(row);
                });

                statusElement.textContent = `ƒê√£ t·∫£i th√†nh c√¥ng ${data.length} h·ªì s∆°.`;
            })
            // 4. B·∫Øt l·ªói (L·ªói m·∫°ng ho·∫∑c l·ªói x·ª≠ l√Ω)
            .catch((error) => {
                console.error("L·ªói khi t·∫£i h·ªì s∆°:", error);
                statusElement.textContent = `L·ªói: Kh√¥ng th·ªÉ k·∫øt n·ªëi ho·∫∑c x·ª≠ l√Ω d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra console.`;
            });
    }

    function zeroPad(numberStr, padStart, char) {
        return numberStr.padStart(padStart, char);
    }

    // D√≤ng d∆∞·ªõi: T·ª± ƒë·ªông t·∫£i d·ªØ li·ªáu khi v·ª´a m·ªü trang (n·∫øu mu·ªën)
    // document.addEventListener('DOMContentLoaded', fetchProfiles);
</script>

{% endblock %}
